================================================================================
Used tool :
https://github.com/davidje13/SequenceDiagram

================================================================================
theme basic
title Unlocking

begin Lock, Smartphone, PCAV

note over Smartphone,PCAV:"Asynchronous action"
Smartphone->PCAV:Authentication (with smartphone ECC key) + send log packet
PCAV->Smartphone:"Command packets ciphered with Lock AES key and signed with AC ECC priv key\nListe of Lock UUID accessible for the Phone"

note over Lock,PCAV:"Opening lock"
Smartphone-> +Lock: Smartphone certificat (CN=UUID of phone)
note left of Lock: "Verify phone certificat signature\nwith AC certificate\nGenerate Random number RN1"
text left "RN1 used to prevent replay (unique session)"
-Lock-> Smartphone:RN1 (same lenght as Lock UUID) ciphered with Phone public key
note right of Smartphone:"decipher RN1 and store RN1"
Smartphone-> +Lock: [datetime].sign(phone ECC priv key)
note left of Lock:"Verify signature \nStore datetime (to prevent replay)"
text left "Datetime becomes lock's clock reference"

note right of Smartphone:"mesure response time between\nsended and receved\npackets to prevent proxy attack"
-Lock-> Smartphone:(Lock UUID) XOR (RN1)
note right of Smartphone:"Retreive Lock UUID = ((Lock UUID) XOR (RN1)) XOR RN1\nControle Lock UUID with white liste"

if "response time > fixed value"
Smartphone->*User: "If response time > fixed value => ask for user interaction"
!User->Smartphone: "Validate OpÃ©ration"
else
note right of Smartphone: "Nothing to do"
end
note right of PCAV :"Anti-Proxy Protection"

Smartphone-> +Lock: "Send command packets for identified Lock UUID"
note left of Lock: Unlock if OK
-Lock-> Smartphone:send log packets ciphered with AES lock key

note over Smartphone,PCAV:Asynchronous action
Smartphone->PCAV:Authentication (with smartphone ECC key) + Send log packet
PCAV->Smartphone:Command packets ciphered with Lock AES key and signed with AC ECC priv key

terminators box
================================================================================
theme basic
title Phone enrolment


Smartphone->PCAV:Authentication (user/password)
PCAV-> +Smartphone: "OK"
note right of Smartphone: "Generate UUID
    Generate ECC key pair
    Generate Certificate Signing Request (CSR)"

-Smartphone->PCAV: "Send CSR (CN=UUID of phone)"
note right of PCAV :"Sign phone certificate with AC
    Store phone certificate"

PCAV->Smartphone:Phone certificate 
text right: "Short lifetime : max 1 week"
note left of Smartphone: "Store phone certificate"


terminators box

================================================================================
theme basic
title Lock enrolment

begin Lock, PC+Fob, PCAV

PC+Fob->PCAV:Authentication (certificate + user/passwd)
PCAV->PC+Fob: AC Certificate (Organization's Certificate)
PC+Fob->Lock: Init + get UUID 
Lock->PC+Fob: UUID
PC+Fob-> +Lock: AC Certificate 
note right of Lock: "Store AC certificate 
    Generate AES key
    Cipher AES key with AC ECC pub key (to upload the key safely)"
    text left "AC used to authentify smartphones"
-Lock->PC+Fob: AES key ciphered
PC+Fob->PCAV: Lock UUID + AES key ciphered



terminators box

================================================================================
